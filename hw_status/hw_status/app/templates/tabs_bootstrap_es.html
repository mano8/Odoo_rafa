<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interfaz IoT Box Odoo 18.0 - Bootstrap 5 (Pestañas ES)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .tab-content .card.h-100 { /* Ensure h-100 works within tab panes */
            display: flex;
            flex-direction: column;
        }
        .tab-content .card.h-100 > .card-body {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .log-output-container, .stty-output-container, .service-status-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0;
        }
        #logOutput, .stty-output-preview {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 100px;
            background-color: #e9ecef;
            padding: 0.75rem;
            border-radius: 0.25rem;
            font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.875em;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status-dot {
            display: inline-block;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .status-green { background-color: #198754; }
        .status-yellow { background-color: #ffc107; }
        .status-red { background-color: #dc3545; }
        .status-gray { background-color: #6c757d; }

        .nav-tabs .nav-link {
            color: #495057;
            border-bottom-width: 2px;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-color: #dee2e6 #dee2e6 #fff;
            font-weight: 500;
        }
        .tab-pane {
            padding-top: 1rem; /* Add some space below tabs */
        }

        .modal-custom { display: none; position: fixed; z-index: 1055; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-custom-content { background-color: #fff; margin: 5% auto; padding: 20px; border: 1px solid rgba(0,0,0,.2); border-radius: 0.3rem; box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); }
        .modal-custom-content.modal-sm-custom { max-width: 500px; margin-top: 10%; }
        .modal-custom-content.modal-lg-custom { max-width: 1000px; }
        #contentModalBody { max-height: 70vh; white-space: pre-wrap; word-break: break-all; background-color: #e9ecef; border-radius: 0.25rem; font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .modal-header-custom { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #dee2e6; margin-bottom: 1rem; }
        .modal-title-custom { margin-bottom: 0; line-height: 1.5; font-size: 1.25rem; }
        .close-custom { font-size: 1.25rem; font-weight: 700; line-height: 1; color: #000; text-shadow: 0 1px 0 #fff; opacity: .5; background-color: transparent; border: 0; cursor: pointer; }
        .close-custom:hover { opacity: .75; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 fw-bold text-dark">Interfaz IoT Box Odoo 18.0</h1>
                <div>
                    <button id="btn-shutdown" class="btn btn-danger me-2">
                        <i class="fas fa-power-off me-1"></i> Apagar
                    </button>
                    <button id="btn-reboot" class="btn btn-danger">
                        <i class="fas fa-sync-alt me-1"></i> Reiniciar
                    </button>
                </div>
            </div>
        </header>

        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="hardware-tab" data-bs-toggle="tab" data-bs-target="#hardware-tab-pane" type="button" role="tab" aria-controls="hardware-tab-pane" aria-selected="true">
                    <i class="fas fa-cogs me-1"></i>Hardware
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-tab-pane" type="button" role="tab" aria-controls="system-tab-pane" aria-selected="false">
                    <i class="fas fa-server me-1"></i>Sistema
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <div class="tab-pane fade show active" id="hardware-tab-pane" role="tabpanel" aria-labelledby="hardware-tab" tabindex="0">
                <main class="row align-items-stretch">
                    <div class="col-lg-4 d-flex flex-column">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h2 class="card-title h5 mb-3">Acciones de Dispositivo</h2>
                                <button id="btnPrintDummy" class="btn btn-primary w-100 mb-2">
                                    <i class="fas fa-print me-2"></i>Imprimir Ticket de Prueba
                                </button>
                                <button id="btnOpenCashDrawer" class="btn btn-primary w-100">
                                    <i class="fas fa-cash-register me-2"></i>Abrir Cajón
                                </button>
                                <div id="actionStatus" class="mt-3 text-muted small"></div>
                            </div>
                        </div>
        
                        <div class="card">
                            <div class="card-body">
                                <h2 class="card-title h5 mb-3">Estado del Dispositivo</h2>
                                <p><span id="connectionStatusDot" class="status-dot status-gray"></span>Estado Conexión: <strong id="connectionStatusText">Desconocido</strong></p>
                                <p><span id="printerStatusDot" class="status-dot status-gray"></span>Estado Impresora: <strong id="printerStatusText">Desconocido</strong></p>
                                <p><span id="paperStatusDot" class="status-dot status-gray"></span>Estado Papel: <strong id="paperStatusText">Desconocido</strong></p>
                            </div>
                        </div>
                    </div>
        
                    <div class="col-lg-4 d-flex flex-column">
                        <div class="card h-100">
                            <div class="card-body">
                                <h2 class="card-title h5 mb-3">Información del Puerto</h2>
                                <div id="portInfoContent" class="d-flex flex-column flex-grow-1">
                                    <p class="text-muted">Obteniendo información del puerto...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 d-flex flex-column">
                        </div>
                </main>
            </div>

            <div class="tab-pane fade" id="system-tab-pane" role="tabpanel" aria-labelledby="system-tab" tabindex="0">
                <main class="row align-items-stretch">
                    <div class="col-lg-4 d-flex flex-column">
                        <div class="card h-100">
                             <div class="card-body">
                                <h2 class="card-title h5 mb-3">Estado de Servicios</h2>
                                <div class="service-status-container">
                                    <p><span id="dockerStatusDot" class="status-dot status-gray"></span>Servicio Docker: <strong id="dockerStatusText">Desconocido</strong></p>
                                    <p><span id="hwProxyStatusDot" class="status-dot status-gray"></span>Servicio hw_proxy: <strong id="hwProxyStatusText">Desconocido</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 d-flex flex-column">
                        <div class="card h-100">
                            <div class="card-body">
                                <h2 class="card-title h5 mb-3">Acciones del Sistema</h2>
                                <button id="btnDownloadDb" class="btn btn-info w-100 mb-2 text-white">
                                    <i class="fas fa-database me-2"></i>Descargar Base de Datos
                                </button>
                                <button id="btnRestartDocker" class="btn btn-warning w-100 mb-2 text-dark">
                                    <i class="fas fa-sync-alt me-2"></i>Reiniciar Contenedores Docker
                                </button>
                                <button id="btnStopDockerCompose" class="btn btn-danger w-100">
                                    <i class="fas fa-stop-circle me-2"></i>Detener Docker Compose
                                </button>
                                <div id="systemActionStatus" class="mt-3 text-muted small"></div>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-4 d-flex flex-column">
                        <div class="card h-100">
                            <div class="card-body">
                                <h2 class="card-title h5 mb-3">Registros del Sistema</h2>
                                <div class="mb-3">
                                    <label for="selectJournal" class="form-label small fw-medium">Servicio (Journal):</label>
                                    <select id="selectJournalSystem" class="form-select form-select-sm">
                                        <option value="iotbox.service">iotbox.service</option>
                                        <option value="docker.service">docker.service</option>
                                        <option value="kernel">kernel</option>
                                        <option value="systemd">systemd</option>
                                        <option value="all">Todos los Servicios</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="selectTimeRangeSystem" class="form-label small fw-medium">Rango de Tiempo:</label>
                                    <select id="selectTimeRangeSystem" class="form-select form-select-sm">
                                        <option value="5m">Últimos 5 minutos</option>
                                        <option value="15m">Últimos 15 minutos</option>
                                        <option value="1h">Última hora</option>
                                        <option value="today">Hoy</option>
                                        <option value="all">Todo</option>
                                    </select>
                                </div>
                                <button id="btnFetchLogsSystem" class="btn btn-secondary w-100 mb-3">
                                    <i class="fas fa-file-alt me-2"></i>Obtener Registros
                                </button>
                                <div class="log-output-container">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h3 class="h6 mb-0">Salida de Registros:</h3>
                                        <button id="btnViewFullLogSystem" class="btn btn-sm btn-outline-secondary" style="display: none;">
                                            <i class="fas fa-expand-arrows-alt me-1"></i>Expandir
                                        </button>
                                    </div>
                                    <pre id="logOutputSystem">Aún no se han obtenido registros.</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal-custom">
        <div class="modal-custom-content modal-sm-custom text-center">
            <p id="modalMessage" class="mb-4 h5">¿Está seguro?</p>
            <div>
                <button id="modalConfirmBtn" class="btn btn-danger mx-2">Confirmar</button>
                <button id="modalCancelBtn" class="btn btn-secondary mx-2">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="contentModal" class="modal-custom">
        <div class="modal-custom-content modal-lg-custom">
            <div class="modal-header-custom">
                <h2 id="contentModalTitle" class="modal-title-custom">Contenido</h2>
                <button id="contentModalCloseBtn" type="button" class="close-custom" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <pre id="contentModalBody" class="p-3"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        const App = {
            UI: {
                // Hardware Tab
                btnPrintDummy: document.getElementById('btnPrintDummy'),
                btnOpenCashDrawer: document.getElementById('btnOpenCashDrawer'),
                actionStatus: document.getElementById('actionStatus'),
                connectionStatusDot: document.getElementById('connectionStatusDot'),
                connectionStatusText: document.getElementById('connectionStatusText'),
                printerStatusDot: document.getElementById('printerStatusDot'),
                printerStatusText: document.getElementById('printerStatusText'),
                paperStatusDot: document.getElementById('paperStatusDot'),
                paperStatusText: document.getElementById('paperStatusText'),
                portInfoContent: document.getElementById('portInfoContent'),
                
                // System Tab
                dockerStatusDot: document.getElementById('dockerStatusDot'),
                dockerStatusText: document.getElementById('dockerStatusText'),
                hwProxyStatusDot: document.getElementById('hwProxyStatusDot'),
                hwProxyStatusText: document.getElementById('hwProxyStatusText'),
                btnDownloadDb: document.getElementById('btnDownloadDb'),
                btnRestartDocker: document.getElementById('btnRestartDocker'),
                btnStopDockerCompose: document.getElementById('btnStopDockerCompose'),
                systemActionStatus: document.getElementById('systemActionStatus'),
                selectJournalSystem: document.getElementById('selectJournalSystem'),
                selectTimeRangeSystem: document.getElementById('selectTimeRangeSystem'),
                btnFetchLogsSystem: document.getElementById('btnFetchLogsSystem'),
                logOutputSystem: document.getElementById('logOutputSystem'),
                btnViewFullLogSystem: document.getElementById('btnViewFullLogSystem'),

                // Global
                btnShutdown: document.getElementById('btn-shutdown'),
                btnReboot: document.getElementById('btn-reboot'),
                confirmationModal: document.getElementById('confirmationModal'),
                modalMessage: document.getElementById('modalMessage'),
                modalConfirmBtn: document.getElementById('modalConfirmBtn'),
                modalCancelBtn: document.getElementById('modalCancelBtn'),
                contentModal: document.getElementById('contentModal'),
                contentModalTitle: document.getElementById('contentModalTitle'),
                contentModalBody: document.getElementById('contentModalBody'),
                contentModalCloseBtn: document.getElementById('contentModalCloseBtn'),
            },
            State: {
                currentModalAction: null,
                fullLogContentSystem: '', // Separate log content for system tab
                fullSttyOutput: '',
            },
            API: {
                _baseUrl: '/api',
                async _fetch(url, options = {}) {
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 500 + 200));
                    console.log(`Simulando fetch a: ${url}`, options);

                    if (url.startsWith(`${this._baseUrl}/status`)) {
                        return {
                            connected: Math.random() > 0.15,
                            printerOnline: Math.random() > 0.2,
                            paperOk: Math.random() > 0.3,
                            paperLow: Math.random() > 0.8,
                            devicePortType: 'SERIAL',
                            serialInfo: {
                                devfile: '/dev/ttyACM0', baudrate: 9600, bytesize: 8, parity: 'N', stopbits: 1, timeout: 1, dsrdtr: false, profile: 'default',
                                readStatus: Math.random() > 0.1 ? 'OK' : 'Error', writeStatus: Math.random() > 0.1 ? 'OK' : 'Error',
                                sttyOutput: `speed 9600 baud; rows 0; columns 0; line = 0;\nLínea larga de prueba: abcdefghijklmnopqrstuvwxyz0123456789`
                            },
                            dockerRunning: Math.random() > 0.2, // New status
                            hwProxyRunning: Math.random() > 0.3, // New status
                        };
                    } else if (url.startsWith(`${this._baseUrl}/print_ticket`)) {
                        return { success: Math.random() > 0.2 };
                    } else if (url.startsWith(`${this._baseUrl}/open_cashdrawer`)) {
                        return { success: Math.random() > 0.1 };
                    } else if (url.startsWith(`${this._baseUrl}/logs`)) {
                        const params = new URLSearchParams(url.split('?')[1]);
                        const journal = params.get('journal');
                        const timeRange = params.get('time_range');
                        const mockLogArray = [
                            `--- Registros para ${journal}, Rango: ${timeRange} ---`,
                            `${new Date().toISOString()} [INFO] Entrada de registro simulada 1.`,
                            ...Array.from({length: 5}, (_, i) => `${new Date().toISOString()} [INFO] Más líneas de registro simuladas ${i + 1}.`)
                        ];
                        return mockLogArray.join('\n');
                    } else if (url.startsWith(`${this._baseUrl}/download_db`)) {
                         // Simulate file download - in a real app, this would trigger a download
                        return { success: true, message: 'Descarga de base de datos iniciada.' };
                    } else if (url.startsWith(`${this._baseUrl}/restart_docker`)) {
                        return { success: true, message: 'Contenedores Docker reiniciados.' };
                    } else if (url.startsWith(`${this._baseUrl}/stop_docker_compose`)) {
                        return { success: true, message: 'Docker Compose detenido.' };
                    }
                     else if (url.startsWith(`${this._baseUrl}/shutdown`) || url.startsWith(`${this._baseUrl}/reboot`)) {
                        return { message: 'Comando recibido' };
                    }
                    throw new Error(`URL de API simulada no reconocida: ${url}`);
                },
                async getDeviceStatus() { try { return await this._fetch(`${this._baseUrl}/status`); } catch (e) { console.error(e); throw e; } },
                async printTicket() { try { const d = await this._fetch(`${this._baseUrl}/print_ticket`, { method: 'POST' }); return d.success; } catch (e) { console.error(e); return false; } },
                async openCashDrawer() { try { const d = await this._fetch(`${this._baseUrl}/open_cashdrawer`, { method: 'POST' }); return d.success; } catch (e) { console.error(e); return false; } },
                async fetchLogs(journal, timeRange) { try { return await this._fetch(`${this._baseUrl}/logs?journal=${encodeURIComponent(journal)}&time_range=${encodeURIComponent(timeRange)}`); } catch (e) { console.error(e); return `Error: ${e.message}`; } },
                async downloadDb() { try { return await this._fetch(`${this._baseUrl}/download_db`, { method: 'POST' }); } catch (e) { console.error(e); return {success: false, message: 'Error al descargar BD.'}; } },
                async restartDocker() { try { return await this._fetch(`${this._baseUrl}/restart_docker`, { method: 'POST' }); } catch (e) { console.error(e); return {success: false, message: 'Error al reiniciar Docker.'}; } },
                async stopDockerCompose() { try { return await this._fetch(`${this._baseUrl}/stop_docker_compose`, { method: 'POST' }); } catch (e) { console.error(e); return {success: false, message: 'Error al detener Docker Compose.'}; } },
                async shutdown() { try { await this._fetch(`${this._baseUrl}/shutdown`, { method: 'POST' }); return true; } catch (e) { console.error(e); return false; } },
                async reboot() { try { await this._fetch(`${this._baseUrl}/reboot`, { method: 'POST' }); return true; } catch (e) { console.error(e); return false; } }
            },
            StatusManager: {
                async updateAll() {
                    App.UI.actionStatus.textContent = 'Obteniendo estado del dispositivo...';
                    App.UI.systemActionStatus.textContent = 'Obteniendo estado de servicios...';
                    try {
                        const status = await App.API.getDeviceStatus();
                        // Hardware Status
                        App.UI.connectionStatusText.textContent = status.connected ? 'Conectado' : 'Desconectado';
                        App.UI.connectionStatusDot.className = `status-dot ${status.connected ? 'status-green' : 'status-red'}`;
                        App.UI.printerStatusText.textContent = status.printerOnline ? 'En línea' : 'Fuera de línea';
                        App.UI.printerStatusDot.className = `status-dot ${status.printerOnline ? 'status-green' : 'status-red'}`;
                        if (status.paperOk) {
                            App.UI.paperStatusText.textContent = 'OK'; App.UI.paperStatusDot.className = 'status-dot status-green';
                        } else if (status.paperLow) {
                            App.UI.paperStatusText.textContent = 'Papel Bajo'; App.UI.paperStatusDot.className = 'status-dot status-yellow';
                        } else {
                            App.UI.paperStatusText.textContent = 'Sin Papel / Error'; App.UI.paperStatusDot.className = 'status-dot status-red';
                        }
                        App.PortInfoManager.display(status.devicePortType, status);
                        App.UI.actionStatus.textContent = 'Estado de hardware actualizado.';

                        // System Services Status
                        App.UI.dockerStatusText.textContent = status.dockerRunning ? 'Activo' : 'Inactivo';
                        App.UI.dockerStatusDot.className = `status-dot ${status.dockerRunning ? 'status-green' : 'status-red'}`;
                        App.UI.hwProxyStatusText.textContent = status.hwProxyRunning ? 'Activo' : 'Inactivo';
                        App.UI.hwProxyStatusDot.className = `status-dot ${status.hwProxyRunning ? 'status-green' : 'status-red'}`;
                        App.UI.systemActionStatus.textContent = 'Estado de servicios actualizado.';

                    } catch (error) {
                        App.UI.actionStatus.textContent = 'Error al obtener estado de hardware.';
                        App.UI.systemActionStatus.textContent = 'Error al obtener estado de servicios.';
                        // Reset all status fields to error
                        const fieldsToReset = [
                            'connectionStatusText', 'printerStatusText', 'paperStatusText', 
                            'dockerStatusText', 'hwProxyStatusText'
                        ];
                        const dotsToReset = [
                            'connectionStatusDot', 'printerStatusDot', 'paperStatusDot',
                            'dockerStatusDot', 'hwProxyStatusDot'
                        ];
                        fieldsToReset.forEach(field => { if(App.UI[field]) App.UI[field].textContent = 'Error'; });
                        dotsToReset.forEach(dot => { if(App.UI[dot]) App.UI[dot].className = 'status-dot status-red'; });
                        if(App.UI.portInfoContent) App.UI.portInfoContent.innerHTML = '<p class="text-danger">No se pudo cargar la información del puerto.</p>';
                    }
                }
            },
            PortInfoManager: { // (No changes needed here from previous version, assuming it's correct)
                display(portType, statusData) {
                    const contentEl = App.UI.portInfoContent;
                    contentEl.innerHTML = '';
                    const title = document.createElement('h3');
                    title.className = 'h6 mb-3 text-secondary';
                    title.textContent = `Tipo de Puerto: ${portType}`;
                    contentEl.appendChild(title);
                    if (portType === 'SERIAL' && statusData.serialInfo) {
                        const info = statusData.serialInfo;
                        const listGroup = document.createElement('ul');
                        listGroup.className = 'list-group list-group-flush mb-3';
                        const addDetail = (term, definition, statusVal = null) => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item d-flex justify-content-between align-items-center small p-2';
                            let statusIndicator = '';
                            if (statusVal === 'OK') statusIndicator = '<span class="status-dot status-green ms-2"></span>';
                            else if (statusVal === 'Error') statusIndicator = '<span class="status-dot status-red ms-2"></span>';
                            li.innerHTML = `${term}: <strong class="text-dark">${definition}</strong> ${statusIndicator}`;
                            listGroup.appendChild(li);
                        };
                        addDetail('Archivo Dispositivo', info.devfile);
                        addDetail('Estado Lectura', info.readStatus, info.readStatus);
                        addDetail('Estado Escritura', info.writeStatus, info.writeStatus);
                        contentEl.appendChild(listGroup);
                        const configContainer = document.createElement('div');
                        configContainer.className = 'mt-auto d-flex flex-column flex-grow-1 stty-output-container';
                        const configHeaderDiv = document.createElement('div');
                        configHeaderDiv.className = 'd-flex justify-content-between align-items-center mb-2';
                        const configTitleHeader = document.createElement('h4');
                        configTitleHeader.className = 'h6 mb-0 text-secondary';
                        configTitleHeader.textContent = 'Configuración Puerto Serie (stty):';
                        configHeaderDiv.appendChild(configTitleHeader);
                        const btnViewFullStty = document.createElement('button');
                        btnViewFullStty.className = 'btn btn-sm btn-outline-secondary';
                        btnViewFullStty.innerHTML = '<i class="fas fa-expand-arrows-alt me-1"></i>Expandir';
                        btnViewFullStty.onclick = () => {
                            App.State.fullSttyOutput = `Baudios: ${info.baudrate}\nTamaño Byte: ${info.bytesize}\nParidad: ${info.parity}\nBits Parada: ${info.stopbits}\nTiempo Espera: ${info.timeout}s\nControl Flujo DSR/DTR: ${info.dsrdtr}\nPerfil: ${info.profile}\n\nSalida stty Completa:\n${info.sttyOutput || 'No disponible'}`;
                            App.ModalManager.showContent('Configuración Completa Puerto Serie (stty)', App.State.fullSttyOutput);
                        };
                        configHeaderDiv.appendChild(btnViewFullStty);
                        configContainer.appendChild(configHeaderDiv);
                        const sttyPre = document.createElement('pre');
                        sttyPre.className = 'stty-output-preview';
                        sttyPre.textContent = `Baudios: ${info.baudrate}\nTamaño Byte: ${info.bytesize}\nParidad: ${info.parity}\nBits Parada: ${info.stopbits}\nTiempo Espera: ${info.timeout}s\nDSR/DTR: ${info.dsrdtr}\nPerfil: ${info.profile}\n\nSalida stty (vista previa):\n${(info.sttyOutput || 'No disponible').substring(0, 150)}...`;
                        configContainer.appendChild(sttyPre);
                        contentEl.appendChild(configContainer);
                    } else if (portType === 'NETWORK') {
                        contentEl.innerHTML += `<p class="text-muted mt-auto">Información Puerto Red (Aún no implementado)</p>`;
                    } else if (portType === 'USB') {
                        contentEl.innerHTML += `<p class="text-muted mt-auto">Información Puerto USB (Aún no implementado)</p>`;
                    } else {
                        contentEl.innerHTML += `<p class="text-muted mt-auto">No hay información detallada del puerto para ${portType}.</p>`;
                    }
                }
            },
            LogManager: { // Updated to handle logs for the system tab
                async fetchAndDisplaySystemLogs() {
                    App.UI.logOutputSystem.textContent = 'Obteniendo registros del sistema...';
                    App.UI.btnViewFullLogSystem.style.display = 'none';
                    const journal = App.UI.selectJournalSystem.value;
                    const timeRange = App.UI.selectTimeRangeSystem.value;
                    try {
                        App.State.fullLogContentSystem = await App.API.fetchLogs(journal, timeRange);
                        App.UI.logOutputSystem.textContent = App.State.fullLogContentSystem;
                        App.UI.btnViewFullLogSystem.style.display = 'inline-block';
                    } catch (error) {
                        App.UI.logOutputSystem.textContent = `Error al obtener registros: ${error.message}`;
                    }
                }
            },
            ModalManager: {
                showConfirmation(message, actionCallback) { App.UI.modalMessage.textContent = message; App.State.currentModalAction = actionCallback; App.UI.confirmationModal.style.display = 'block'; },
                hideConfirmation() { App.UI.confirmationModal.style.display = 'none'; App.State.currentModalAction = null; },
                showContent(title, content) { App.UI.contentModalTitle.textContent = title; App.UI.contentModalBody.textContent = content; App.UI.contentModal.style.display = 'block'; },
                hideContent() { App.UI.contentModal.style.display = 'none'; }
            },
            ActionHandler: {
                async printDummyTicket() {
                    App.UI.actionStatus.textContent = 'Imprimiendo ticket de prueba...';
                    const success = await App.API.printTicket();
                    App.UI.actionStatus.textContent = success ? 'Ticket de prueba impreso correctamente.' : 'Error al imprimir ticket de prueba.';
                    App.UI.actionStatus.className = `mt-3 small ${success ? 'text-success' : 'text-danger'}`;
                    App.StatusManager.updateAll();
                },
                async openCashDrawer() {
                    App.UI.actionStatus.textContent = 'Abriendo cajón...';
                    const success = await App.API.openCashDrawer();
                    App.UI.actionStatus.textContent = success ? 'Cajón abierto correctamente.' : 'Error al abrir cajón.';
                    App.UI.actionStatus.className = `mt-3 small ${success ? 'text-success' : 'text-danger'}`;
                },
                async downloadDb() {
                    App.UI.systemActionStatus.textContent = 'Iniciando descarga de base de datos...';
                    const response = await App.API.downloadDb();
                    App.UI.systemActionStatus.textContent = response.message;
                    App.UI.systemActionStatus.className = `mt-3 small ${response.success ? 'text-success' : 'text-danger'}`;
                    if (response.success) {
                        // En una app real, se podría generar un enlace de descarga o usar FileSaver.js
                        // Para simulación, solo mostramos el mensaje.
                        console.log("Simulación: La descarga de la BD se manejaría aquí.");
                    }
                },
                async restartDocker() {
                    App.UI.systemActionStatus.textContent = 'Reiniciando contenedores Docker...';
                    const response = await App.API.restartDocker();
                    App.UI.systemActionStatus.textContent = response.message;
                    App.UI.systemActionStatus.className = `mt-3 small ${response.success ? 'text-warning' : 'text-danger'}`;
                },
                async stopDockerCompose() {
                    App.UI.systemActionStatus.textContent = 'Deteniendo Docker Compose...';
                    const response = await App.API.stopDockerCompose();
                    App.UI.systemActionStatus.textContent = response.message;
                    App.UI.systemActionStatus.className = `mt-3 small ${response.success ? 'text-danger' : 'text-danger'}`;
                },
                async shutdownServer() {
                    App.ModalManager.hideConfirmation(); App.UI.actionStatus.textContent = 'Enviando comando de apagado...'; // actionStatus for global feedback
                    const success = await App.API.shutdown();
                    App.UI.actionStatus.textContent = success ? 'Comando de apagado enviado.' : 'Error al enviar comando de apagado.';
                    App.UI.actionStatus.className = `mt-3 small ${success ? 'text-info' : 'text-danger'}`;
                },
                async rebootServer() {
                    App.ModalManager.hideConfirmation(); App.UI.actionStatus.textContent = 'Enviando comando de reinicio...'; // actionStatus for global feedback
                    const success = await App.API.reboot();
                    App.UI.actionStatus.textContent = success ? 'Comando de reinicio enviado.' : 'Error al enviar comando de reinicio.';
                    App.UI.actionStatus.className = `mt-3 small ${success ? 'text-info' : 'text-danger'}`;
                }
            },
            init() {
                // Hardware Tab Actions
                App.UI.btnPrintDummy.addEventListener('click', App.ActionHandler.printDummyTicket);
                App.UI.btnOpenCashDrawer.addEventListener('click', App.ActionHandler.openCashDrawer);

                // System Tab Actions
                App.UI.btnDownloadDb.addEventListener('click', App.ActionHandler.downloadDb);
                App.UI.btnRestartDocker.addEventListener('click', App.ActionHandler.restartDocker);
                App.UI.btnStopDockerCompose.addEventListener('click', App.ActionHandler.stopDockerCompose);
                App.UI.btnFetchLogsSystem.addEventListener('click', App.LogManager.fetchAndDisplaySystemLogs);
                App.UI.btnViewFullLogSystem.addEventListener('click', () => 
                    App.ModalManager.showContent(App.State.fullLogContentSystem ? 'Registro Completo del Sistema' : 'Registro del Sistema', App.State.fullLogContentSystem || 'No hay contenido de registro.')
                );
                
                // Global Actions
                App.UI.btnShutdown.addEventListener('click', () => App.ModalManager.showConfirmation('¿Está seguro que desea apagar el servidor?', App.ActionHandler.shutdownServer));
                App.UI.btnReboot.addEventListener('click', () => App.ModalManager.showConfirmation('¿Está seguro que desea reiniciar el servidor?', App.ActionHandler.rebootServer));
                
                // Modals
                App.UI.modalConfirmBtn.addEventListener('click', () => { if (App.State.currentModalAction) App.State.currentModalAction(); });
                App.UI.modalCancelBtn.addEventListener('click', App.ModalManager.hideConfirmation);
                App.UI.contentModalCloseBtn.addEventListener('click', App.ModalManager.hideContent);
                window.onclick = (event) => { 
                    if (event.target == App.UI.confirmationModal) App.ModalManager.hideConfirmation(); 
                    if (event.target == App.UI.contentModal) App.ModalManager.hideContent(); 
                };
                
                // Initial Load
                App.StatusManager.updateAll();
                App.UI.logOutputSystem.textContent = 'Aún no se han obtenido registros.';
                App.UI.portInfoContent.innerHTML = '<p class="text-muted">Obteniendo información del puerto...</p>';
            }
        };
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
